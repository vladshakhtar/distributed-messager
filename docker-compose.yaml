services:
  nginx:
    image: nginx:latest
    ports:
      - 80:80
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - reader-app
      - writer-app

  reader-app:
    image: eclipse-temurin:21
    volumes:
      - ./jars/reader.jar:/app/app.jar
    command: tail -f /dev/null 
    depends_on:
      - query-router
      - redis

  writer-app:
    image: eclipse-temurin:21
    volumes:
      - ./jars/writer.jar:/app/app.jar
    command: tail -f /dev/null 
    depends_on:
      - query-router
      - redis

  redis:
    image: redis:latest
    ports:
      - 6379:6379

  config-server:
    image: mongo:latest
    command: mongod --configsvr --replSet configReplSet --port 27019
    ports:
      - 27019:27019
    volumes:
      - mongodb_config_data:/data/db

  shard1:
    image: mongo:latest
    command: mongod --shardsvr --replSet shard1ReplSet --port 27018
    ports:
      - 27018:27018
    volumes:
      - mongodb_shard1_data:/data/db

  shard2:
    image: mongo:latest
    command: mongod --shardsvr --replSet shard2ReplSet --port 27017
    ports:
      - 27017:27017
    volumes:
      - mongodb_shard2_data:/data/db

  query-router:
    image: mongo:latest
    command: mongos --configdb configReplSet/config-server:27019 --port 27020
    ports:
      - 27020:27020
    depends_on:
      - config-server
      - shard1
      - shard2
    volumes:
      - ./mongo-init:/mongo-init

volumes:
  mongodb_config_data:
  mongodb_shard1_data:
  mongodb_shard2_data: